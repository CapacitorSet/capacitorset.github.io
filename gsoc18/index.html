<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="CapacitorSet">
  <title>Google Summer of Code 2018: contributing to Honeytrap</title>
  <style type="text/css">
    /* Source: https://bestmotherfucking.website (with changes) */
    body {
      margin: 0 auto;
      max-width: 40em;
      padding: 1rem .62em;
      font-size: 1.2em;
      /* line-height: 1.62; */
      line-height: 24px;
      font-family: "Open Sans", sans-serif;
    }
    h1, h2, h3 {
      line-height: 1.2;
    }
    blockquote {
      background-color: #eee;
      border-left: 6px solid silver;
      padding: 0.1em 1em 0.1em 1em;
      margin: 0;
    }
    pre {
      padding: 0.5rem 1rem;
      background-color: #f8f8f8;
      border: 1px solid #eee;
      border-radius: 0.15rem;
      margin-bottom: 1rem;
      overflow: auto;
    }
    a, a:visited {
      color: #07a;
    }

    @media print {
      body {
        max-width: none
      }
    }
  </style>
</head>
<body>
<h1 id="google-summer-of-code-2018-contributing-to-honeytrap">Google Summer of Code 2018: contributing to Honeytrap</h1>
<p>This article is a summary of my contribution to <a href="https://github.com/honeytrap/honeytrap">Honeytrap</a> in the context of <a href="https://summerofcode.withgoogle.com/dashboard/">Google Summer of Code</a> 2018, as required by Google.</p>
<h2 id="in-a-nutshell">In a nutshell</h2>
<p>I achieved the proposed project, “Implementing Yara rules in Honeytrap” (code: <a href="https://github.com/honeytrap/honeytrap/pull/326">1</a>, <a href="https://github.com/CapacitorSet/elasticsearch-yara">2</a>, <a href="https://github.com/honeytrap/honeytrap-web/pull/6">3</a>). I also implemented several features both in the scope of my project and outside of it, for example <a href="https://github.com/honeytrap/honeytrap/pull/284">transforms</a>, <a href="https://github.com/honeytrap/honeytrap/pull/202">Redis</a>/<a href="https://github.com/honeytrap/honeytrap/pull/208">memcached</a>/<a href="https://github.com/honeytrap/honeytrap/pull/385">adb</a> honeypots, <a href="https://github.com/honeytrap/honeytrap/pull/224">ports-based config</a>.</p>
<h2 id="in-scope-contributions">In-scope contributions</h2>
<p>My proposal was about implementing <a href="https://github.com/VirusTotal/yara">Yara</a> rules in the <a href="https://github.com/honeytrap/honeytrap">Honeytrap</a> honeypot. Yara is a pattern-matching language, commonly used to classify malware samples in a language- and platform-agnostic way; I figured it’d be interesting to apply it to events produced by a honeypot.</p>
<p>The text of my proposal follows (amended for conciseness).</p>
<blockquote>
<p>Yara is very extensible, and could be conveniently used to describe malicious actors interacting with a honeypot. Specifically, with the pattern-matching we’ll be able to identify specific attacks and link them to specific botnets or exploits.</p>
<p>The final goal of my application is to fully integrate Yara in Honeytrap spanning several contexts, a work which directly translates to a logical timeline:</p>
<ul>
<li><em>Yara filter</em>: Honeytrap implements <em>filters</em>, which are components that select data from a channel and pipe it into another. A Yara-based filter enables the user to write smart filters that group interactions logically: an example application would be a malware researcher storing all Mirai connection attempts into ElasticSearch for later analysis, or a company logging Nmap-based connections to a canary to be alerted of internal network scans. Such filters would allow for both stateless matching (operating on single events, independently of the others) and more complex stateful matching.</li>
<li><em>Yara search</em>: users may also be interested in analyzing interactions at a later time. As such, there may be interest in searching logs using Yara rules. This section would implement Yara searching in ElasticSearch, the Honeytrap backend of choice, through server-side scripting.</li>
<li><em>Yara reporting</em>: Honeytrap implements a Web-based dashboard. Integrating Yara into the dashboard is a key step in making this contribution easy to use.</li>
<li><em>Yara definitions</em>: once the pattern-matching infrastructure is in place, I plan to create Yara definitions for common threats and other items of interest: among them, specific CVEs (eg. CVE-2017-0144 aka EternalBlue), botnets (Mirai network), tools (sqlmap, nmap).</li>
</ul>
</blockquote>
<h3 id="yara-filter">Yara filter</h3>
<p>I eventually found that filters were too simple for the project requirements, so I refactored them into <em>transforms</em>, a stateful component which receives single events and can send zero, one or more events (in this sense, it is similar to a flat map).</p>
<p>I proceeded to implement a transform for Yara matching in the form of a filter (you pass a Yara file in the config, it filters all events that match at least one rule); however, I found that there are many situations in which a filter is not sufficient (eg. detecting an event from ruleset A, followed by an event from ruleset B), so I made a generic Yara “library” which can be reused in custom complex transforms.</p>
<p>As a result of this development, I also <a href="#northern-lightsyara-parser">contributed</a> to an external project, a Yara parser.</p>
<blockquote>
<p>PRs: <a href="https://github.com/honeytrap/honeytrap/pull/284">#284</a>, <a href="https://github.com/honeytrap/honeytrap/pull/326">#326</a></p>
</blockquote>
<h3 id="yara-search">Yara search</h3>
<p>I developed an ElasticSearch plugin for searching events that match a Yara ruleset.</p>
<p>As a personal note, the development of this feature was by far the most excruciating, due to the sheer complexity of Java development and the lack of developer documentation for ElasticSearch.</p>
<blockquote>
<p>Repo: <a href="https://github.com/CapacitorSet/elasticsearch-yara"><code>CapacitorSet/elasticsearch-yara</code></a></p>
</blockquote>
<h3 id="yara-reporting">Yara reporting</h3>
<p>I added a Yara panel to the Web UI.</p>
<blockquote>
<p>PR: <a href="https://github.com/honeytrap/honeytrap-web/pull/6"><code>honeytrap/honeytrap-web#6</code></a></p>
</blockquote>
<h3 id="yara-definitions">Yara definitions</h3>
<p>TODO</p>
<h2 id="out-of-scope-contributions">Out-of-scope contributions</h2>
<h3 id="services">Services</h3>
<p>I wrote “services” (i.e. honeypots) for the following protocols/softwares: <a href="https://github.com/honeytrap/honeytrap/pull/202">Redis</a>, <a href="https://github.com/honeytrap/honeytrap/pull/208">Memcached</a>, <a href="https://github.com/honeytrap/honeytrap/pull/245">TFTP</a>, <a href="https://github.com/honeytrap/honeytrap/pull/256">WordPress</a>, <a href="https://github.com/honeytrap/honeytrap/pull/281">CWMP/TR-069</a>, <a href="https://github.com/honeytrap/honeytrap/pull/373">SNMP</a>, <a href="https://github.com/honeytrap/honeytrap/pull/385">ADB</a>.</p>
<h3 id="bugfixes">Bugfixes</h3>
<p><a href="https://github.com/honeytrap/honeytrap/pull/241">#241</a>, <a href="https://github.com/honeytrap/honeytrap/pull/265">#265</a>, <a href="https://github.com/honeytrap/honeytrap/pull/308">#308</a>, <a href="https://github.com/honeytrap/honeytrap/pull/362">#362</a>, <a href="https://github.com/honeytrap/honeytrap/pull/384">#384</a>, <a href="https://github.com/honeytrap/honeytrap/pull/407">#407</a>, <a href="https://github.com/honeytrap/honeytrap/pull/408">#408</a>.</p>
<h3 id="code-cleanup">Code cleanup</h3>
<p>Honeytrap: <a href="https://github.com/honeytrap/honeytrap/pull/257">#257</a>, <a href="https://github.com/honeytrap/honeytrap/pull/267">#267</a>, <a href="https://github.com/honeytrap/honeytrap/pull/280">#280</a>, <a href="https://github.com/honeytrap/honeytrap/pull/289">#289</a>, <a href="https://github.com/honeytrap/honeytrap/pull/371">#371</a>.</p>
<p>Honeytrap-web: <a href="https://github.com/honeytrap/honeytrap-web/pull/5">#5</a></p>
<h3 id="features">Features</h3>
<ul>
<li><a href="https://github.com/honeytrap/honeytrap/pull/224">Refactoring the ports/services configuration</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/228">Multiple config files</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/259">RabbitMQ pusher</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/282">SendFile for storers</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/312">Event counter</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/319">Warning for unused config keys</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/338">GeoIP</a></li>
<li><a href="https://github.com/honeytrap/honeytrap/pull/390">Generate service docs from Go files</a></li>
</ul>
<h2 id="contributions-to-external-projects">Contributions to external projects</h2>
<h3 id="northern-lightsyara-parser"><a href="https://github.com/Northern-Lights/yara-parser">Northern-Lights/yara-parser</a></h3>
<p>I found out that to apply Yara rules I had to first define variables, which led to the use of a parser to extract variables from the rule source. To do that, I <a href="https://github.com/honeytrap/honeytrap-web/pull/6">extended</a> an existing parser in Go, <code>Northern-Lights/yara-parser</code>.</p>
<h3 id="yara"><a href="https://github.com/VirusTotal/yara">Yara</a></h3>
<p>Bug reports: unexpected behaviour when…</p>
<ul>
<li><a href="https://github.com/VirusTotal/yara/issues/908">defining the same variable twice</a></li>
<li><a href="https://github.com/VirusTotal/yara/issues/920">defining a variable with the same name as a rule</a></li>
</ul>
<script type="text/javascript">
  // Self-hosted Piwik tracking
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//matomo.jwlss.pw/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//matomo.jwlss.pw/piwik.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
</body>
</html>